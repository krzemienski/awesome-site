---
spec: production-audit
basePath: specs/production-audit
phase: design
task: 1/1
updated: 2026-02-07T23:00:00Z
---

# Progress: production-audit

## Original Goal

Full production readiness audit - comprehensive audit of the entire app for production deployment readiness.

## Completed Tasks

- Research phase: comprehensive production readiness audit across 10 domains
- [x] 1.1 Add typecheck script to package.json
- [x] 1.2 Generate baseline Prisma migration
- [x] 1.3 Switch to @prisma/adapter-neon + remove hardcoded DB fallback - 47c4fcb
- [x] 1.4 Create global-error.tsx standalone error page
- [x] 1.5 Integrate Sentry error tracking - a602e88
- [x] 1.6 Add auth endpoint rate limiting
- [x] 1.7 [VERIFY] Phase 1 infrastructure checkpoint - typecheck+lint PASS, build DB-only failure
- [x] 1.8 Create data migration script
- [x] 1.9 Create data verification script
- [x] 1.10 [VERIFY] Phase 1 complete checkpoint - all 10 deliverables verified
- [x] 2.1 Implement nonce-based CSP in middleware
- [x] 2.2 Switch to distributed rate limiting with Upstash Redis

## Current Task

Awaiting next task

## Learnings

- App is actually Next.js 16.1.6 (not 15 as described in task context) - package.json confirms
- Prisma uses `@prisma/adapter-pg` (native pg driver), NOT `@prisma/adapter-neon` - no WebSocket connection pooling for serverless
- No database migrations exist at all despite `prisma.config.ts` referencing a migrations path
- In-memory rate limiter (`Map<string, SlidingWindowEntry[]>`) is per-serverless-instance, ineffective on Vercel
- Auth endpoints (`/api/auth/*`) are explicitly exempted from rate limiting in middleware.ts:79
- CSP uses `unsafe-inline` for both scripts and styles due to theme/variation inline scripts
- `global-error.tsx` is missing - root layout errors will show default Next.js error page
- No Sentry or any error tracking - error boundaries only console.error
- No privacy policy, terms of service, or cookie consent pages exist
- 3 different env vars used for site URL (NEXT_PUBLIC_BETTER_AUTH_URL, NEXT_PUBLIC_BASE_URL, NEXT_PUBLIC_SITE_URL)
- .env.example is incomplete - missing GITHUB_TOKEN, NEXT_PUBLIC_BASE_URL, NEXT_PUBLIC_SITE_URL
- Social OAuth providers fallback to empty string "" instead of failing loudly when env vars missing
- `next/image` is never used despite having `remotePatterns` configured
- Only 4 console statements in entire codebase (all in error boundaries) - very clean
- Zero TODO/FIXME comments - clean codebase
- All 83+ API routes properly use withAuth or withAdmin, or are legitimately public read-only endpoints
- 8 Zod schema files provide comprehensive input validation at API boundaries
- Prisma fallback to localhost:5432 in prisma.ts will silently fail in production
- ReactQueryDevtools is included without dev-mode guard (auto-no-ops in prod but adds bundle size)
- C4 (connection pooling) and M7 (hardcoded DB fallback) merged into single US-4 since both touch `src/lib/prisma.ts`
- Cookie consent (M6) depends on analytics (H5) - consent must gate analytics loading
- US-22 (noUncheckedIndexedAccess) depends on US-13 (typecheck script) for verification
- Nonce-based CSP (H1) is highest-effort single item (~1 day) due to theme/variation inline scripts
- 6 unresolved questions remain: deployment target, traffic volume, API key use case, data retention, EU jurisdiction, deprecated route strategy
- 25 user stories cover all 26 issues (M7 merged into US-4 with C4)
- [REQ UPDATE] Admin panel has 19 tabs (not 14 as originally stated): overview, resources, categories, subcategories, sub-subcategories, tags, edit-suggestions, users, api-keys, analytics, enrichment, learning-journeys, export, settings, github-sync, database, audit, validation, link-health
- [REQ UPDATE] Existing Neon PostgreSQL IS the production DB - data migration is export/import, not a new DB setup
- [REQ UPDATE] Prisma schema has 28+ models; migration must handle Resource, Category, Subcategory, SubSubcategory, Tag, ResourceTag at minimum
- [REQ UPDATE] Schema uses autoincrement IDs for content tables (Resource, Category, etc.) - migration must preserve or remap IDs to maintain FK relationships
- [REQ UPDATE] Playwright already installed (`@playwright/test ^1.58.2`) - no additional setup needed for E2E
- [REQ UPDATE] Public routes confirmed: homepage, /categories (with 3 levels of nesting), /resources, /resources/[id], /search, /about, /journeys, /journeys/[id], /resources/[id]/suggest-edit
- [REQ UPDATE] Phase 5 (E2E Validation) is P0 but runs last - depends on all other phases being complete + data migrated
- [REQ UPDATE] Migration needs both pooled (DATABASE_URL) and direct (DIRECT_DATABASE_URL) Neon connections - pooled for app runtime, direct for prisma migrate
- [REQ UPDATE] Out of scope clarified: user accounts/sessions NOT migrated, only content data; UserInteraction/ViewHistory/Favorites start fresh
- [REQ UPDATE] 4 new unresolved questions added: source DB schema mapping, schema differences, user account migration scope, staging vs production E2E target

- [DESIGN] Legacy DB uses Drizzle ORM with text-based category references (resources.category is text, not FK). Migration must create Category records first, then remap text -> integer FK for each resource.
- [DESIGN] Legacy schema has composite PKs on junction tables (resource_tags, user_favorites, user_bookmarks). New Prisma schema uses auto-increment IDs on ResourceTag. Migration must handle PK structure difference.
- [DESIGN] `@prisma/adapter-neon` uses WebSocket transport, not TCP. `ws` polyfill needed for Node.js runtime; edge runtime uses native WebSocket. Middleware does NOT import Prisma so edge compatibility is not an issue.
- [DESIGN] CSP nonce requires moving CSP from `next.config.ts` static headers to `middleware.ts` dynamic headers. Static headers in next.config.ts cannot contain per-request values.
- [DESIGN] `checkRateLimit` becomes async with Upstash. This is a breaking change to the function signature but middleware is already async so compatible.
- [DESIGN] `search_vector` column must be `Unsupported("tsvector")` in Prisma schema since Prisma has no native tsvector type. All FTS queries must use `$queryRaw`.
- [DESIGN] Error boundary files are `"use client"` -- cannot use pino (server-only) in them. Use `Sentry.captureException` for client error boundaries, pino for server-side API routes/server components.
- [DESIGN] Existing admin E2E tests (`e2e/admin-tabs.spec.ts`) already test 20 tabs with loginAsAdmin helper. New audit spec extends this pattern with screenshots and console error assertions.
- [DESIGN] Three Prisma migrations planned: 0001_init (baseline), 0002_full_text_search (tsvector+GIN), 0003_indexes (additional Resource indexes). Must be applied sequentially.
- [DESIGN] API versioning uses re-export pattern (v1/resources re-exports from resources/route) to avoid moving files or changing imports.
- [DESIGN] Cookie consent gates analytics loading -- `<Analytics />` and `<SpeedInsights />` only render after user accepts non-essential cookies.
- [DESIGN] Sentry + Next.js 16 compatibility is an unresolved question. `@sentry/nextjs` v8.x supports Next.js 14/15; may need v9 or canary for 16.

- [TASKS] 43 total tasks across 6 phases: Phase 1 (10 tasks), Phase 2 (9 tasks), Phase 3 (8 tasks), Phase 4 (8 tasks), Phase 5 (8 tasks), Phase 6 (2 tasks)
- [TASKS] Typecheck script (M1) moved from Phase 3 to Phase 1.1 -- all subsequent tasks depend on `npm run typecheck` for verification
- [TASKS] Quality commands discovered: `npm run lint` (eslint), `npm run typecheck` (tsc --noEmit, after 1.1), `npm run build` (next build). No unit test runner.
- [TASKS] E2E specs will use existing Playwright setup: `npx playwright test e2e/*.spec.ts`, `loginAsAdmin` helper, `navigateToTab` pattern from `e2e/admin-tabs.spec.ts`
- [TASKS] Existing admin-tabs.spec.ts tests 20 tabs (including "research"), not 19. New audit spec should align with actual tab count.
- [TASKS] `src/app/error.tsx` is named `GlobalError` but is actually the root error boundary (not global-error). The actual global-error.tsx does not exist yet.
- [TASKS] `checkRateLimit` is called in 3 places: middleware.ts (2 call sites) and auth-middleware.ts (1 call site in withApiKey). All must await after making it async.
- [TASKS] `src/lib/json-ld.tsx` already uses `NEXT_PUBLIC_SITE_URL` -- only `auth-client.ts`, `sitemap.ts`, `robots.ts` need URL var consolidation
- [TASKS] Deprecated routes use different HTTP methods: awesome-list has GET, learning-paths/generate has POST, learning-paths/suggested has GET. All get 410 treatment.
- [TASKS] Auth rate limiting uses pathname.includes() for login paths (/sign-in, /sign-up) since Better Auth catch-all routes are under /api/auth/sign-in/email etc. Login paths get 5/min/IP, general auth gets 10/min/IP.
- [MIGRATION] `prisma migrate diff` flag `--to-schema-datamodel` was removed in Prisma 6.x; use `--to-schema` instead
- [MIGRATION] DB not available locally (localhost:51214) -- `migrate resolve` and `migrate status` skipped. Migration SQL file (738 lines) is the key deliverable; resolve/status must be run against production Neon DB when available
- [TASKS] `@prisma/adapter-pg` and `pg` + `@types/pg` must be uninstalled when switching to `@prisma/adapter-neon` to avoid conflicts
- [TASKS] `prisma.config.ts` currently uses `DATABASE_URL` -- must switch to `DIRECT_DATABASE_URL` for migrations (non-pooled Neon connection required for DDL)
- [TASKS] Risk: noUncheckedIndexedAccess (task 4.3) could produce many type errors. Allocated as single large task -- may need splitting during execution.
- [TASKS] Phase 5 E2E tasks write specs first, then run all together in 5.5. This allows fixing spec issues before the combined run.
- [MIGRATION] Legacy source tables use snake_case (categories, subcategories, sub_subcategories, resources, resource_tags, tags). Target Prisma tables use PascalCase ("Category", "Subcategory", "SubSubcategory", "Resource", "ResourceTag", "Tag"). Column names are camelCase in target.
- [MIGRATION] Legacy resources.category is TEXT name, not slug. categoryNameToSlug mapping built from source categories table is essential for FK resolution.
- [MIGRATION] pg and @types/pg already installed as devDependencies -- no npm install needed for migration scripts.
- [MIGRATION] verify-migration.ts uses same raw pg Pool pattern as migrate-data.ts. Connects to both target (DATABASE_URL) and source (SOURCE_DATABASE_URL) for cross-DB spot-checks. Six checks: resource count >= 2000, category count match, no NULL categoryIds, subcategory FK integrity, subSubcategory FK integrity, and 10 random title+URL spot-checks.

## Blockers

- None currently

## Interview Responses

### Design Interview (from design.md)
- Architecture style: Extend existing architecture - build on current patterns, fix issues in-place
- Technology constraints: No constraints - use whatever libraries/tools make sense
- Integration approach: Use existing APIs and interfaces - leverage existing Prisma schema, API routes, service patterns

### Requirements Interview (from requirements.md)
- Primary users: Both developers and end users
- Priority tradeoffs: Feature completeness - ensure all features work correctly before hardening
- Success criteria: Zero critical, high, medium, and low issues remaining - fix everything across all severity levels

### Tasks Interview (from tasks.md)
- Testing depth: Comprehensive - include E2E (full Playwright validation as specified in Phase 5)
- Deployment approach: Standard CI/CD pipeline
- Execution priority: Quality first - thorough from the start, each fix verified before moving on

### Verification: 1.7 [VERIFY] Phase 1 infrastructure checkpoint
- Status: PASS (with acceptable build caveat)
- `npm run typecheck` (tsc --noEmit): PASS (exit 0, zero errors)
- `npm run lint` (eslint): PASS (exit 0, zero errors)
- `npm run build` (next build): FAIL (exit 1) -- DB-only prerender failure
  - Compiled successfully in 3.8s
  - TypeScript check passed
  - Failed during "Generating static pages" at "/" route
  - Error: `[object Object]` -- Prisma connection error when `getCategoryTree()` attempts DB query during prerender
  - Root cause: No DATABASE_URL available at build time; homepage uses `revalidate = 600` which triggers SSG prerender
  - This is NOT a code error -- it is the expected DB-connection-during-prerender failure documented in task instructions as acceptable
  - Other warnings (non-blocking): Better Auth social provider env vars missing, metadataBase not set, middleware-to-proxy deprecation

### Verification: 1.10 [VERIFY] Phase 1 complete checkpoint
- Status: PASS (with acceptable build caveat)
- Quality Commands:
  - `npm run typecheck` (tsc --noEmit): PASS (exit 0, zero errors)
  - `npm run lint` (eslint): PASS (exit 0, zero errors)
  - `npm run build` (next build): FAIL (exit 1) -- DB-only prerender failure (acceptable per task spec)
    - Compiled successfully in 3.4s, TypeScript passed
    - Failed at "Generating static pages" on "/" route -- Neon DB connection unavailable at build time
- Phase 1 Deliverables:
  - prisma/migrations/0001_init/migration.sql: EXISTS
  - sentry.client.config.ts: EXISTS
  - sentry.server.config.ts: EXISTS
  - sentry.edge.config.ts: EXISTS
  - src/instrumentation.ts: EXISTS
  - src/app/global-error.tsx: EXISTS
  - Auth rate limiting in middleware.ts: EXISTS (login 5/min/IP, general auth 10/min/IP via checkRateLimit)
  - Neon adapter in src/lib/prisma.ts: EXISTS (@prisma/adapter-neon with ws polyfill)
  - scripts/migrate-data.ts: EXISTS
  - scripts/verify-migration.ts: EXISTS
- All 10 Phase 1 deliverables verified present

## Next

Task 2.3 Add full-text search with tsvector + GIN index
