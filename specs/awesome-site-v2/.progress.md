---
spec: awesome-site-v2
basePath: ./specs/awesome-site-v2
phase: design
task: 0/0
updated: 2026-02-06T14:52:00Z
---

# Progress: awesome-site-v2

## Original Goal

Complete ground-up rebuild of the Awesome Video Dashboard (awesome-list-site at /Users/nick/Desktop/awesome-list-site) into a modern Next.js application at /Users/nick/Desktop/awesome-site. Requirements:

- **Full feature parity** with legacy app (75+ API endpoints, 30+ features, 26 DB tables, admin panel)
- **All shadcn/ui components** (new-york style) for every UI element
- **Stitch MCP** for designing every screen (using GEMINI_3_PRO model)
- **Better Auth** for authentication (email/password + Google + GitHub OAuth)
- **Prisma ORM** with PostgreSQL (can reuse same DB or create new, redesign schema as needed)
- **Multi-theme support** - cyberpunk default + 3-4 additional user-switchable themes
- **Functional validation** at each phase with real screenshots via browser automation
- **Skills to activate**: design-md, stitch-loop, remotion, enhance-prompt, shadcn-ui, better-auth, and 20+ others
- **Validation protocol**: Test as end-user and admin, verify edits propagate, import/export works, etc.

Source: /Users/nick/Desktop/awesome-list-site
Target: /Users/nick/Desktop/awesome-site

## Completed Tasks

- Research phase: exhaustive legacy analysis, technology research, design system documentation
- Requirements phase: 46 user stories, 81 functional requirements, 25 non-functional requirements
- Design phase: full architecture with mermaid diagrams, 31-model Prisma schema plan, 72-step implementation roadmap, feature module definitions, middleware chain, TypeScript interfaces, error handling strategy, caching strategy, security considerations

## Current Task

Awaiting next task

## Completed Tasks (Phase 4)
- [x] 4.2 Build reusable DataTable component - 4 files: data-table.tsx (generic TanStack Table wrapper with sortable columns via ArrowUpDown, row selection with Checkbox, server-side pagination with page/pageSize/pageCount props, column visibility toggle via DropdownMenu with Settings2 icon, search input when searchColumn provided, loading skeleton rows, page size selector 20/50/100, prev/next pagination buttons), stat-card.tsx (Card with icon, label, large value, optional trend with TrendingUp/TrendingDown icons and green/red coloring), confirm-dialog.tsx (AlertDialog wrapper with configurable title/description/confirmLabel, destructive/default variant, loading state with Loader2 spinner, onConfirm callback with preventDefault), error-display.tsx (Alert variant=destructive with AlertCircle icon, title, message, optional retry Button).
- [x] 4.1 Build admin layout with sidebar and lazy tab routing - 19 files: admin layout.tsx (server component with metadata), admin page.tsx (client component with React.lazy + Suspense for 14 tabs, useSearchParams-based tab routing, outer Suspense wrapper for Next.js), admin-sidebar.tsx (14 nav items with lucide-react icons, ScrollArea, URL search param routing via useRouter/useSearchParams, active tab highlighting), admin-layout.tsx (wrapper with sidebar + content area, flex layout with overflow handling), use-admin.ts (3 TanStack Query hooks: useAdminStats/useAdminResources/useAdminUsers with 1min staleTime, typed params and paginated results), 14 placeholder tab components under components/admin/tabs/ (overview, resources, categories, subcategories, sub-subcategories, users, edit-suggestions, enrichment, github-sync, api-keys, analytics, tags, learning-journeys, settings).

## Completed Tasks (Phase 3)
- [x] 3.9 Implement view history tracking - 7 files: history-service.ts (recordView creates ViewHistory entry, getHistory with paginated findMany including resource relations), interaction-service.ts (trackInteraction creates UserInteraction with InteractionType enum and Prisma.InputJsonValue metadata cast), API route /api/history (GET paginated history with limit/offset, POST record view with resourceId validation), API route /api/interactions (POST track interaction with type validation against enum values view/click/bookmark/rate/complete), history page at (protected)/history/page.tsx (client-side fetch with pagination, Card-based list with resource title/description/category/tags/timestamp, EmptyState, Previous/Next pagination), view-tracker.tsx (client component fires POST /api/history on mount, fire-and-forget for authenticated users), modified resource detail page to include ViewTracker component.
- [x] 3.8 Implement user preferences and profile page - 4 files: user-schemas.ts (Zod updatePreferencesSchema with skillLevel, preferredCategories, learningGoals, timeCommitment, theme, viewMode, emailNotifications), preference-service.ts (getPreferences with auto-create defaults, updatePreferences via upsert), API route /api/preferences (GET/PUT with withAuth, inline Zod validation on PUT), profile page at (protected)/profile/page.tsx (user info card with avatar/name/email/role, preferences form with Select dropdowns for skillLevel/timeCommitment/theme, Checkbox grid for categories via useCategories, tag-style learning goals input with add/remove, ToggleGroup for viewMode, Switch for emailNotifications, Save button with loading state, API key management placeholder card).
- [x] 3.7 Implement edit suggestion flow - 5 files: edit-types.ts (EditDiff, EditSuggestion, AiEditAnalysis, toEditSuggestion converter), edit-schemas.ts (submitEditSchema with editType enum correction/enhancement/report, proposedChanges record, justification), edit-service.ts (submitEdit, getEdits with status filter, approveEdit, rejectEdit with status guard, applyDiff for title/url/description fields), API route at /api/resources/[id]/edits (GET list + POST submit with withAuth), edit-suggestion-form.tsx (Dialog with edit type Select, current values as read-only hints, editable title/url/description fields, justification textarea, diff builder comparing old vs new, success state).
- [x] 3.6 Implement resource submission flow - 3 files: added submitResourceSchema to resource-schemas.ts (url, title, categoryId, subcategoryId, subSubcategoryId, tags, description), submission-form.tsx (4-step wizard: Step 1 URL+title with check-url on blur, Step 2 category cascade 3-level via useCategories, Step 3 tags chip input+description, Step 4 review+submit), submit/page.tsx (protected page wrapping SubmissionForm). POST /api/resources already handles pending status. AI analyze button is disabled placeholder.
- [x] 3.4 Implement bookmarks service and UI (with notes) - 6 files: bookmark-service.ts (toggleBookmark, updateBookmarkNotes, listBookmarks, getBookmarkedIds), API routes (GET /api/bookmarks, POST/PUT/DELETE /api/bookmarks/[resourceId]), bookmark-button.tsx (Bookmark icon toggle + StickyNote icon for notes Dialog with Textarea), use-bookmarks.ts (useBookmarks, useBookmarkedIds, useBookmarkNotes, useToggleBookmark, useUpdateBookmarkNotes via TanStack Query+mutations), bookmarks page at (protected)/bookmarks/page.tsx (client-side search/filter by title/description/notes, resource cards with notes preview, EmptyState).
- [x] 3.3 Implement favorites service and UI - Created 6 files: favorite-service.ts (toggleFavorite, listFavorites, isFavorited, getFavoritedIds), API routes (GET /api/favorites with ?ids=true for bulk check, POST/DELETE /api/favorites/[resourceId]), favorite-button.tsx (Heart icon with optimistic toggle), use-favorites.ts (useFavoriteIds, useFavorites, useFavoriteToggle with optimistic update via queryClient), favorites page at (protected)/favorites/page.tsx (grid view with empty state). Also fixed pre-existing type error in bookmarks/[resourceId]/route.ts (intersection type with params Promise incompatible with withAuth signature -- changed to cast pattern).
- [x] 3.2 Build user menu and auth state UI - Created user-menu.tsx (Avatar dropdown with profile/favorites/bookmarks/history/admin links, sign out action). Updated top-bar.tsx to replace placeholder User button with UserMenu component. Uses useAuth() from auth-provider for typed session with role field, signOut from hooks/use-auth. Shows Skeleton while loading, Sign In/Sign Up buttons when unauthenticated, avatar dropdown when authenticated. Admin Dashboard link conditionally rendered for admin role.
- [x] 3.1 Build auth pages (login, register, forgot-password)

## Completed Tasks (Phase 2 continued)
- [x] 2.10 Implement Cmd+K search dialog - 5 new files: search-types.ts, search-index.ts (Fuse.js + TanStack Query 10min cache), use-search.ts hook, search-dialog.tsx (CommandDialog with grouped results), search-trigger.tsx (button with Cmd+K hint). Updated top-bar.tsx to integrate SearchDialog + SearchTrigger. Cmd+K opens, debounced query, results grouped by resource/category/tag, selecting navigates via router.push.
- [x] 2.9 Build resource browse and detail pages - Browse page (client component with Suspense for useSearchParams, ResourceGrid + filters + sort + pagination, URL state sync), Detail page (server component with generateMetadata, breadcrumb, tags, AI metadata section, related resources placeholder, favorite/bookmark/suggest-edit buttons), 4 hooks (useResources, useCategories, useDebounce, useViewMode)
- [x] 2.8 Build category pages (3-level navigation with breadcrumbs) - 4 pages: /categories (all), /categories/[slug] (category detail), /categories/[slug]/[subSlug] (subcategory), /categories/[slug]/[subSlug]/[subSubSlug] (deepest level) + category-breadcrumb.tsx component
- [x] 2.7 Build home page with category grid - page.tsx (hero + category grid + SEO metadata), category-card.tsx (icon, name, resource count, description, slug link)
- [x] 2.6 Build shared resource UI components - 10 files: resource-card, resource-list-item, resource-compact-item, resource-grid, view-mode-toggle, resource-filters, resource-sort, pagination-controls, empty-state, loading-skeleton
- [x] 2.4 Implement category API routes (hierarchy + admin CRUD)
- [x] 2.3 Implement resource API routes (CRUD + filters + pagination)
- [x] 2.2 Create category feature module (service, schemas, types)

## Completed Tasks (Phase 2)
- [x] 2.1 Create resource feature module (service, schemas, types) - pending commit

## Completed Tasks (Implementation)
- [x] 1.1 Write complete Prisma schema (31 models) - pending commit
- [x] 1.2 Push schema to Neon database - pushed 35 tables to local PostgreSQL (awesome_list_v2), generated Prisma client at src/generated/prisma
- [x] 1.3 Create Prisma client singleton and shared API utilities - prisma.ts, api-response.ts, api-error.ts, constants.ts
- [x] 1.4 Configure Better Auth server and client - auth.ts, auth-client.ts, catch-all route, .env.example
- [x] 1.5 Create auth middleware chain - withAuth, withAdmin, withValidation, withApiKey in src/features/auth/
- [x] 1.6 [VERIFY] Quality checkpoint: lint + typecheck - PASS, zero errors
- [x] 1.7 Set up 4-theme OKLCH system with flash prevention - globals.css with 4 themes, theme-provider.tsx, theme-script.tsx, theme-switcher.tsx
- [x] 1.8 Update root layout with providers, fonts, and metadata - JetBrains Mono + Inter fonts, QueryProvider + AuthProvider + ThemeProvider wrapping, metadata with OG tags
- [x] 1.9 Build layout shell (TopBar, Footer, Container, MobileNav) - 64px fixed TopBar with logo, nav links, search placeholder, theme switcher, user menu placeholder, mobile hamburger; Sheet-based MobileNav; Footer with GitHub/API Docs links; Container 1400px max-width; layout.tsx updated with TopBar + main(pt-16) + Footer
- [x] 1.10 Set up Next.js middleware for auth redirects - src/middleware.ts with protected/admin/auth route classification, session check via auth.api.getSession, callbackUrl on redirects, matcher excludes _next/static, _next/image, favicon.ico, api/
- [x] 1.11 [VERIFY] Quality checkpoint + build verification - PASS, lint fix applied (ThemeSwitcher useSyncExternalStore), all three commands pass
- [x] 1.12 POC Checkpoint: Verify foundation works end-to-end - ALL CHECKS PASS

## Learnings

- **Theme system**: 4-theme OKLCH system uses `data-theme` attribute on `<html>` via next-themes. `:root` sets cyberpunk defaults, `[data-theme="cyberpunk"]` aliases same values. Flash prevention via inline `<script>` in `<head>` reading localStorage `theme` key. ThemeSwitcher uses shadcn DropdownMenu with color dots. `@theme inline` block maps `--font-heading` and `--font-body` CSS vars. Each theme defines ALL shadcn CSS vars (30+ vars including sidebar, chart, radius). Tailwind v4 `--font-sans` and `--font-mono` mapped to `--font-body` and `--font-heading` respectively.
- **Better Auth 1.4.18 config**: `betterAuth()` from `"better-auth"`, `prismaAdapter(prisma, { provider: "postgresql" })` from `"better-auth/adapters/prisma"`, `toNextJsHandler(auth)` from `"better-auth/next-js"`, `createAuthClient()` from `"better-auth/react"`. Session defaults to 7-day expiry. `nextCookies()` plugin required for Next.js cookie integration. Social providers warn at build if clientId/clientSecret empty but don't error.
- **Auth client import**: Use `"better-auth/react"` for `createAuthClient` with React hooks (`useSession`). Set `baseURL` via `NEXT_PUBLIC_BETTER_AUTH_URL` env var.
- **Auth middleware pattern**: `withAuth` uses `auth.api.getSession({ headers: req.headers })` for cookie-based session validation. `withAdmin` composes around `withAuth`. `withValidation` uses `schema.safeParse()` for Zod validation with field-level error details. `withApiKey` hashes header value with SHA-256 and looks up in ApiKey table. All return `RouteHandler` type for composability. Banned user check built into `withAuth`. ApiKey model uses `revokedAt` (nullable DateTime) instead of `isActive` boolean.
- Legacy schema has 26 tables with Drizzle ORM. Resources link to categories via TEXT name matching, not FK. Prisma redesign should add proper FK relations.
- Legacy uses TWO coexisting patterns: route registration functions (older) and Module interface (newer research module). New app should use consistent Next.js Route Handlers.
- Better Auth v1.4+ supports experimental.joins for optimized Prisma queries. Must use `@better-auth/cli generate` to create auth tables in Prisma schema.
- Prisma 7 requires explicit output path in schema.prisma (already configured at `../src/generated/prisma`).
- Legacy has 60+ API endpoints across 15 route files. Endpoint reimplementation is the largest work item.
- Legacy theme system stores 8 themes with full HSL/OKLCH CSS variable sets. New project uses OKLCH-only cyberpunk design. Port 4 legacy themes to OKLCH.
- AI enrichment uses batch job queue pattern with retry logic (max 3 retries). Research system has cost tracking (tokens, USD) per model.
- GitHub sync is bidirectional with awesome-lint validation. This is the highest-complexity feature to port.
- New project already has 42 shadcn/ui components installed (new-york style), Stitch MCP project (ID: 14908959412283318545), and basic Next.js 16 scaffold.
- Legacy admin panel has 8 sub-modules: stats, users, resources, edits, categories, export, database, enrichment. Plus research module (8 endpoints).
- `next-themes` already in new project dependencies for theme switching.
- No test infrastructure exists in new project. Quality commands limited to lint + build.
- SPECIFICATION.md references Drizzle ORM + Next.js 15, but user goal specifies Prisma 7 + Next.js 16. Requirements follow user goal. This divergence needs explicit acknowledgment.
- SPECIFICATION.md defines 28 tables (expanded from legacy 26) adding: view_history, step_completions, ai_response_cache, github_resource_mapping, api_rate_limits, api_usage_logs, resource_edit_fields. Prisma schema must include all.
- Admin panel expanded from legacy 8 tabs to 14 tabs: Overview, Resources, Categories, Subcategories, Sub-subcategories, Users, Edit Suggestions, Enrichment, GitHub Sync, API Keys, Analytics, Tags, Learning Journeys, Settings.
- Google OAuth listed in user goal but absent from SPECIFICATION.md details. Flagged as unresolved question.
- Email provider for Better Auth verification/reset flows undefined. Must be configured before auth can work end-to-end.
- Functional validation mandate: all acceptance criteria designed for browser-based verification with screenshots. Zero unit tests, zero mocks per project rules.
- Requirements total: 46 user stories across 16 areas, 81 functional requirements (FR-1 through FR-81), 25 non-functional requirements. 6 unresolved questions flagged.
- **Architecture**: Feature-module organization under `src/features/` with co-located service, schemas, types per domain. Route Handlers in `app/api/` call into feature services.
- **Schema redesign**: 31 Prisma models (up from legacy 26). Key fix: resource-to-category via proper FK (Int) instead of TEXT name matching. 5 new tables: view_history, step_completion, ai_response_cache, github_resource_mapping, api_rate_limit, api_usage_log, site_setting.
- **Middleware pattern**: `withAuth`, `withAdmin`, `withValidation(zodSchema)`, `withApiKey` composable wrappers. Each returns a RouteHandler. Compose via nesting: `withAuth(withValidation(schema, handler))`.
- **API key hashing**: SHA-256 (not bcrypt like legacy) for O(1) lookup via hash index. Store `keyPrefix` (first 8 chars) for display. Full key shown once on creation.
- **Theme mechanism**: `data-theme` attribute on `<html>` + CSS custom properties per theme. Inline `<head>` script reads localStorage before first paint (flash prevention). 4 themes all OKLCH.
- **Admin panel**: Single page at `/admin` with client-side tab routing. 14 lazy-loaded tab components. TanStack Table for all data grids with server-side pagination.
- **Job processing**: In-process async (no external queue like Redis/BullMQ). Acceptable for single-server deployment. One active enrichment job at a time.
- **Rate limiting**: In-memory sliding window Map. Three tiers: anonymous 30/min/IP, session 100/min/user, API key tier-based per hour.
- **Search**: Client-side only (Fuse.js + cmdk). Index built on first Cmd+K open, cached 10min via TanStack Query.
- **State management**: TanStack Query for server state + nuqs for URL state. No global client state store needed (YAGNI).
- **Implementation is 8 phases, 72 steps**: Foundation -> Core Data -> User Features -> Admin Panel -> Advanced Features -> AI Research -> SEO -> Functional Validation.
- **Highest risk**: GitHub sync bidirectional (import first, export second, conflict resolution last). Second risk: 60+ route handlers surface area (mitigated by shared middleware).
- **Prisma 7 datasource**: `url` property is NO LONGER supported in schema.prisma datasource block. Connection URL must be in `prisma.config.ts` only. Schema datasource block should only have `provider`.
- **Schema model count**: Task says "31 models" but actual count across all groups (Better Auth 4 + Content 6 + User 5 + Edit 2 + Journey 4 + AI 4 + Research 2 + GitHub 4 + API 3 + Config 1) = 35 models total. All are implemented.
- **Database connection**: `.env` has Prisma Accelerate proxy URL (`prisma+postgres://localhost:51...`) which requires proxy running. `.env.local` has direct `postgresql://localhost:5432/awesome_list_v2`. For Prisma CLI commands, use `--url "postgresql://nick@localhost:5432/awesome_list_v2"` to bypass proxy. Local PostgreSQL is running and accessible.
- **Broadened .gitignore**: Changed `/src/generated/prisma` to `/src/generated/` for future-proofing any additional generators.
- **Prisma 7 import path**: Generated client has no `index.ts` barrel file. Import from `@/generated/prisma/client` (not `@/generated/prisma`).
- **Prisma 7 driver adapter required**: `PrismaClient` constructor requires `adapter` or `accelerateUrl`. For direct PostgreSQL, use `@prisma/adapter-pg` with `PrismaPg({ connectionString })`. Installed `@prisma/adapter-pg`, `pg`, and `@types/pg`.
- **Layout shell pattern**: TopBar is "use client" (needs useState for mobile nav toggle + usePathname for active link). Footer is Server Component (no client interactivity, dynamic year via `new Date().getFullYear()`). Container is Server Component (pure wrapper). MobileNav is "use client" (Sheet controlled open/close). TopBar is `fixed top-0 z-50` with `backdrop-blur`, main content uses `pt-16` to offset 64px header height. Search trigger is placeholder Button with Cmd+K kbd hint (will be wired to cmdk in task 2.10).
- **Legacy domain allowlist**: 78+ domains ported from `server/ai/claudeService.ts` to `src/lib/constants.ts`.
- **Next.js 16 middleware deprecation**: Next.js 16.1.6 shows warning "The 'middleware' file convention is deprecated. Please use 'proxy' instead." but `src/middleware.ts` still works and builds successfully. Middleware appears as `ƒ Proxy (Middleware)` in build output. Prisma generated client triggers Node.js module warnings (node:path, node:url, node:buffer) in edge runtime context — these are warnings only, build succeeds. Session check in middleware uses `auth.api.getSession({ headers: request.headers })` which imports the full auth config including Prisma adapter. Route classification: PROTECTED (redirect to /login with callbackUrl), ADMIN (redirect to /login if no session, redirect to / if not admin), AUTH (redirect to / if already authenticated).

### Verification: 2.5 [VERIFY] Quality checkpoint: lint + typecheck + build
- Status: PASS
- Commands: npm run lint (exit 0, 3 warnings only), npx tsc --noEmit (exit 0), npm run build (exit 0)
- Warnings (non-blocking): 3 lint warnings for unused `_ctx` params in category/subcategory/sub-subcategory route files, Better Auth missing OAuth credentials, Next.js middleware deprecation
- Fixes needed: None (all warnings, zero errors)
- Commit needed: No

### Task Planning Insights
- **98 total tasks** across 10 phases (Foundation, Core Data, User Features, Admin Panel, Advanced Features, AI Research, SEO/Polish, Functional Validation, Quality Gates, PR Lifecycle)
- **Quality checkpoints every 2-3 tasks** throughout all phases -- 14 [VERIFY] checkpoints total
- **Phase 1 is the critical path**: Prisma schema (31 models), Better Auth config, theme system, layout, middleware chain must all work before anything else
- **Task sizing**: Each task targets ~200 lines max, grouped by feature module (service + API route + UI component together where possible)
- **Missing dependencies**: `@tanstack/react-table` is NOT in package.json despite being mentioned in design. Must `npm install` it. Also need `nuqs` for URL state.
- **Env vars needed**: Only `DATABASE_URL` exists. Must add: `BETTER_AUTH_SECRET`, `BETTER_AUTH_URL`, `GITHUB_CLIENT_ID`, `GITHUB_CLIENT_SECRET`, `GOOGLE_CLIENT_ID`, `GOOGLE_CLIENT_SECRET`, `ANTHROPIC_API_KEY`
- **Existing globals.css**: Default shadcn light/dark theme. Must be fully replaced with 4-theme OKLCH system in task 1.7
- **Existing layout.tsx**: Default Geist fonts. Must be replaced with JetBrains Mono + Inter in task 1.8
- **Admin approach**: Single `/admin` page with client-side tab routing via state/hash, not file-system routes. All 14 tabs lazy-loaded.
- **Validation is cURL-based**: No browser automation configured. All Phase 8 validation uses cURL + JSON parsing. Build verification via `npm run build`.
- **Home page pattern**: Server Component async page with `getCategoryTree()` called directly. Uses `export const metadata: Metadata` (not `generateMetadata()` function) since home page metadata is static. Category card computes `totalResources` by summing `_count.resources` across all 3 hierarchy levels (category + subcategories + sub-subcategories). Build renders page as `○ (Static)` — prerendered at build time. Hero uses `bg-gradient-to-r from-primary via-accent-foreground to-primary bg-clip-text text-transparent` for gradient text. Responsive grid: `grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4`.
- **Category pages pattern**: 4 server-component pages under `src/app/(public)/categories/`. Top-level categories page is static (prerendered). Deeper pages use `generateMetadata()` for dynamic SEO. Subcategory/sub-subcategory slug lookups use `prisma.subcategory.findFirst()` with parent slug chain in `where` clause (not service functions, since service only has ID-based lookups). CategoryBreadcrumb accepts `BreadcrumbEntry[]` items -- last item rendered as `BreadcrumbPage` (no link), earlier items as `BreadcrumbLink`. ResourceGrid ("use client") works fine inside server components for server-rendered resource display. `(public)` route group created for public-facing pages without affecting URL structure.
- **Middleware edge runtime fix**: Original middleware imported `auth` from `@/lib/auth` which pulls in Prisma (Node.js-only modules like `node:path`). This caused 500 errors in dev mode edge runtime. Fix: replaced `auth.api.getSession()` with lightweight cookie-based session check (`better-auth.session_token` cookie). Build still passes. Admin role verification deferred to server-side `withAdmin` middleware in route handlers. Cookie names: `better-auth.session_token` (dev) and `__Secure-better-auth.session_token` (production HTTPS).
- **Health endpoint**: Created `src/app/api/health/route.ts` using `prisma.$queryRawUnsafe("SELECT 1 as ok")` for DB connectivity check. Returns `apiSuccess({ status, database, timestamp })`.
- **GitHub sync risk mitigation**: Import (task 5.5) before export (task 5.6) before admin UI (task 5.7). Incremental complexity.
- **No `@tanstack/react-virtual` in deps**: Needed for admin tables with 1000+ rows. Add in task 4.2 if DataTable needs virtual scrolling.
- **Zod 4 z.record()**: Requires two arguments `z.record(keySchema, valueSchema)` instead of Zod 3's single argument `z.record(valueSchema)`. Use `z.record(z.string(), z.unknown())` for `Record<string, unknown>`.
- **Resource feature module pattern**: Types file re-exports Prisma types and adds domain-specific interfaces (ResourceWithRelations, ResourceFilters, PaginatedResponse). Schemas file uses Zod with `z.coerce.number()` for query params. Queries file builds Prisma `where`/`orderBy`/`include` from filters. Service file implements CRUD with proper error handling via AppError/Errors. Tags resolved via upsert on slug.
- **Root layout provider pattern**: layout.tsx is Server Component. Client providers (QueryProvider, AuthProvider, ThemeProvider) must be separate `"use client"` components in `src/providers/`. Nesting order: QueryProvider > AuthProvider > ThemeProvider > children. ThemeScript goes in `<head>` as Server Component. `suppressHydrationWarning` on `<html>` prevents next-themes mismatch. JetBrains Mono set as `--font-heading`, Inter as `--font-body`. TanStack Query default staleTime 5min, gcTime 15min. AuthProvider wraps Better Auth `useSession()` into a context with typed user including role field. React 19 context uses `value` prop instead of `Provider` subcomponent.
- **Category feature module pattern**: 4 files (types, schemas, queries, service). Types re-export Prisma models and add `WithChildren`/`WithCount` interfaces for tree building. Schemas use `.transform()` to auto-generate slug from name. Queries build Prisma `include` clauses for 3-level tree with `_count: { select: { resources: true } }` at each level, ordered by `displayOrder: "asc"`. Service implements full CRUD for all 3 levels with delete protection (checks both resource count AND child count), slug uniqueness enforcement (Category uses global unique slug, Subcategory uses `@@unique([categoryId, slug])`, SubSubcategory uses `@@unique([subcategoryId, slug])`), and display order swap operations. Prisma compound unique fields accessed as `categoryId_slug` and `subcategoryId_slug`.
- **Category API route pattern**: 6 route files under `src/app/api/categories/`, `subcategories/`, `sub-subcategories/`. DRY approach: no separate `/api/admin/` counterparts; public GET routes (no auth) + POST on collection routes and PUT/DELETE on `[id]` routes use `withAdmin`. Subcategory/sub-subcategory GET list endpoints flatten the category tree. `ctx.params` cast to `Promise<{ id: string }>` for `withAdmin`-wrapped handlers since middleware extends `RouteContext` with generic `Record<string, string>`.
- **Fuse.js type import pattern**: `import Fuse, { type IFuseOptions } from "fuse.js"` -- `Fuse` is exported as default class, `IFuseOptions` as named type. Cannot use `Fuse.IFuseOptions` namespace style. `limit` is NOT an `IFuseOptions` property -- pass it to `fuseIndex.search(query, { limit: 20 })` instead.
- **Search dialog state management**: SearchDialog receives `open`/`onOpenChange` as props from TopBar (which owns the state). This avoids duplicate state from multiple `useSearch()` calls. SearchDialog manages its own `query` state internally. Cmd+K listener lives inside SearchDialog component.
- **Better Auth client useSession() type limitation**: `useSession()` from `@/lib/auth-client` does NOT include custom `additionalFields` (like `role`) in its TypeScript type. The server-side `auth.$Infer.Session.user` does include them. For client components needing `role`, use `useAuth()` from `@/providers/auth-provider` which casts and types the role field. Import `signOut` separately from `@/hooks/use-auth` for sign-out actions.
- **Multi-step form pattern**: SubmissionForm uses useState for step tracking (1-4) and formData object. Each step rendered conditionally by `step` value. Field-level validation via `validateStep(currentStep)` before advancing. Category cascade: useCategories() returns full tree, subcategory/sub-subcategory selects derive from selected parent via `.find()`. Tag input uses comma/Enter key handlers with `addTag()` callback. URL uniqueness checked on blur via GET `/api/resources/check-url?url=...`. Submit POSTs to `/api/resources` which already handles `status: "pending"` for non-admin users. `submitResourceSchema` is separate from `createResourceSchema` -- same shape but semantically distinct for form validation vs API validation.
- **Route handler params type pattern**: Do NOT use intersection type `AuthenticatedRouteContext & { params: Promise<{ resourceId: string }> }` in withAuth handlers -- `Record<string, string>` is not assignable to specific param shapes. Instead use `AuthenticatedRouteContext` and cast inline: `const { resourceId } = (await ctx.params) as { resourceId: string }`.
- **Edit suggestion Prisma enum alignment**: Task spec referenced editType values "update"/"correction"/"addition" but actual Prisma schema defines `EditType` enum as `correction`/`enhancement`/`report` and `EditStatus` as `pending`/`approved`/`rejected`. Also Prisma model uses `justification String` (required, not optional), `reviewedAt DateTime?` and `reviewFeedback String?` (not `reviewNote`). Always check actual schema.prisma enums before implementing types. The `toEditSuggestion()` converter in edit-types.ts transforms Prisma's JSON `proposedChanges` (record of field->oldValue/newValue) into typed `EditDiff[]` array.
- **Prisma JSON field type casting**: When passing `Record<string, unknown>` to a Prisma `Json` field, TypeScript requires casting to `Prisma.InputJsonValue`. Import `Prisma` namespace from `@/generated/prisma/client` and cast: `(metadata ?? {}) as Prisma.InputJsonValue`.
- **Browse page Suspense requirement**: Next.js 16 requires `useSearchParams()` to be wrapped in a `<Suspense>` boundary. Client component pages using `useSearchParams` must split into a wrapper (default export with Suspense) and a content component (uses the hook). Without this, static generation fails with "useSearchParams() should be wrapped in a suspense boundary" error.
- **useCategories pattern**: Category data changes infrequently, so `useCategories()` uses 30min staleTime. `useCategory(slug)` derives from the full tree to avoid extra API calls. This pattern works well when the full dataset is small (category trees typically <100 items).
- **Resource UI component pattern**: 10 shared components under `src/components/resources/` and `src/components/shared/`. All "use client". ResourceGrid accepts `viewMode` prop ("grid"|"list"|"compact") and renders the appropriate sub-component. ResourceFilters uses 500ms debounce on search (useEffect+setTimeout). ViewModeToggle uses shadcn ToggleGroup with "single" type. PaginationControls accepts page/limit/total and emits onPageChange/onLimitChange. EmptyState accepts optional LucideIcon, title, description, actionLabel+onAction. LoadingSkeleton accepts variant ("card"|"list"|"compact") + count. ResourceCard/ListItem accept onFavorite/onBookmark callbacks (mutations wired later). Tags capped at 3 in card/list views. Favorite/bookmark buttons use fill-current for active state.
- **Resource API route pattern**: 5 route files under `src/app/api/resources/`. Public GET routes (list, detail, check-url) have no auth. POST requires `withAuth` (any logged-in user). PUT/DELETE/approve/reject require `withAdmin`. Middleware composition: `withAdmin` wraps `withAuth` internally so just `withAdmin(handler)` suffices. For auth+validation, do inline Zod parsing inside the withAuth/withAdmin handler (avoids type composition issues between middleware). Query params parsed via `resourceFiltersSchema.safeParse()` on GET list. Dynamic route params accessed via `await ctx.params` (Next.js 16 Promise pattern). `rejectResource(id, approvedById)` takes admin user ID as second param (not reason string).
- **Admin panel architecture**: Single `/admin` page with client-side tab routing via URL search params (`?tab=resources`). Layout is a server component (just metadata wrapper), page is "use client" with outer Suspense for useSearchParams (Next.js 16 requirement). 14 tabs lazy-loaded via `React.lazy()` + dynamic `import()` with `.then(m => ({ default: m.NamedExport }))` pattern for named exports. `TAB_COMPONENTS` Record maps tab keys to lazy components. AdminSidebar uses `useSearchParams`/`useRouter` for navigation, ScrollArea for overflow. AdminLayoutWrapper provides sidebar + content flex layout with `h-[calc(100vh-4rem)]` to account for TopBar. Tab placeholders in `components/admin/tabs/` will be replaced with real implementations in subsequent tasks.

### Verification: 1.6 [VERIFY] Quality checkpoint: lint + typecheck
- Status: PASS
- Commands: npm run lint (exit 0), npx tsc --noEmit (exit 0)
- Issues found: 0
- Fixes needed: None
- Commit needed: No

### Verification: 1.11 [VERIFY] Quality checkpoint + build verification
- Status: PASS
- Commands: npm run lint (exit 0 after fix), npx tsc --noEmit (exit 0), npm run build (exit 0)
- Issues found: 1 lint error in theme-switcher.tsx (react-hooks/set-state-in-effect)
- Fix applied: Replaced useState+useEffect mounted pattern with useSyncExternalStore in ThemeSwitcher
- Build warnings (non-blocking): 3 Prisma edge runtime warnings (node:path, node:url, node:buffer), 2 Better Auth missing OAuth credentials
- Commit needed: Yes (lint fix)

### POC Checkpoint: 1.12 Foundation End-to-End Verification
- **Build**: `npm run build` passes clean (warnings only: Prisma edge runtime, missing OAuth creds)
- **Dev server**: `npm run dev` starts in ~550ms on port 3000
- **Home page**: Renders full HTML with TopBar (Resources, Categories, Journeys, Search nav links), Footer, "Awesome" branding, `data-theme` attribute, `suppressHydrationWarning`
- **Health/DB**: `GET /api/health` returns `{"success":true,"data":{"status":"healthy","database":"connected"}}`
- **Auth**: `GET /api/auth/ok` returns `{"ok":true}`
- **Theme CSS**: 8 `data-theme` selectors in compiled CSS (4 themes), `--primary` and other shadcn CSS vars present, JetBrains Mono + Inter fonts loaded
- **Middleware fix applied**: Replaced Prisma-importing auth with lightweight cookie check for edge runtime compatibility

## Blockers

- None currently

## Interview Responses

### Requirements Interview (from requirements.md)
- Primary users: End users via UI (regular users browsing resources, bookmarking, submitting + admins managing content)
- Priority tradeoffs: Feature completeness (every legacy feature must work before shipping - full parity is non-negotiable)
- Success criteria: All of the above (full parity, better UX, and solid performance)

### Design Interview (from design.md)
- Architecture style: Feature-based modules (organize by domain: resources/, auth/, admin/, ai/ with co-located routes, services, types)
- Technology constraints: No constraints (architect free to choose patterns within decided stack)
- Integration approach: Fresh database (awesome_list_v2), migrate data later after core features work
- API pattern: Shared middleware chain (withAuth, withAdmin, withValidation wrappers, consistent error responses)
- Admin panel: Client-side SPA under /admin (lazy-loaded tabs, TanStack Table for data grids, minimal SSR)

### Tasks Interview (from tasks.md)
- Testing depth: Functional validation only (NO mocks, NO unit tests — real UI, real server, cURL, screenshots)
- Deployment approach: Standard Vercel deploy with Neon PostgreSQL
- Execution priority: Quality first (thorough from the start, slower but more polished)

### Verification: 2.11 [VERIFY] Quality checkpoint + build
- Status: PASS
- Commands: npm run lint (exit 0, 6 warnings only), npx tsc --noEmit (exit 0), npm run build (exit 0)
- Fixes applied: 2 lint errors fixed
  - `search-dialog.tsx`: Replaced useEffect setState-on-close with wrapped onOpenChange callback
  - `use-view-mode.ts`: Replaced useState+useEffect with useSyncExternalStore for localStorage read
- Warnings (non-blocking): 3 unused `_ctx` params, 1 react-hooks/exhaustive-deps, 2 unused type imports, Better Auth missing OAuth credentials, Next.js middleware deprecation
- Build: 12 static pages, 15 dynamic routes, compiled in 1.3s
- Commit needed: Yes (lint fixes in search-dialog.tsx and use-view-mode.ts)

### Verification: 3.5 [VERIFY] Quality checkpoint
- Status: PASS
- Commands: npm run lint (exit 0, 7 warnings only), npx tsc --noEmit (exit 0), npm run build (exit 0)
- Warnings (non-blocking): 1 unused import ResourceGrid in bookmarks/page.tsx, 3 unused `_ctx` params, 1 react-hooks/exhaustive-deps in resource-filters.tsx, 2 unused type imports in resource-grid.tsx, Better Auth missing OAuth credentials, Next.js middleware deprecation
- Fixes needed: None (all warnings, zero errors)
- Build: 19 static pages, 11 dynamic routes (30 total), compiled in 1.9s
- Commit needed: No

### Verification: 3.10 [VERIFY] Quality checkpoint + build
- Status: PASS
- Commands: npm run lint (exit 0, 7 warnings only), npx tsc --noEmit (exit 0), npm run build (exit 0)
- Warnings (non-blocking): 1 unused import ResourceGrid in bookmarks/page.tsx, 3 unused `_ctx` params in category/subcategory/sub-subcategory routes, 1 react-hooks/exhaustive-deps in resource-filters.tsx, 2 unused type imports in resource-grid.tsx, Better Auth missing OAuth credentials, Next.js middleware deprecation
- Fixes needed: None (all warnings, zero errors)
- Build: 25 static pages, 12 dynamic routes (37 total), compiled in 1.7s
- Commit needed: No

## Next

Task 4.2 complete. Next: Task 4.3 Build admin overview tab (stats + activity feed).
