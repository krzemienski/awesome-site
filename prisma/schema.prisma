// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// Enums
// ============================================================================

enum ResourceStatus {
  pending
  approved
  rejected
  archived
}

enum ApiKeyTier {
  free
  standard
  premium
}

enum JourneyStatus {
  draft
  published
  archived
}

enum JourneyDifficulty {
  beginner
  intermediate
  advanced
}

enum EnrichmentJobStatus {
  pending
  processing
  completed
  failed
  cancelled
}

enum ResearchJobType {
  validation
  enrichment
  discovery
  trend_analysis
  comprehensive
}

enum GithubSyncAction {
  import
  export
}

enum EditType {
  correction
  enhancement
  report
}

enum EditStatus {
  pending
  approved
  rejected
}

enum InteractionType {
  view
  click
  bookmark
  rate
  complete
}

// ============================================================================
// Better Auth Tables
// ============================================================================

model User {
  id            String    @id @default(cuid())
  name          String
  email         String    @unique
  emailVerified Boolean   @default(false)
  image         String?
  role          String    @default("user")
  banned        Boolean   @default(false)
  banReason     String?
  banExpires    DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  sessions             Session[]
  accounts             Account[]
  submittedResources   Resource[]          @relation("SubmittedResources")
  approvedResources    Resource[]          @relation("ApprovedResources")
  favorites            UserFavorite[]
  bookmarks            UserBookmark[]
  preference           UserPreference?
  interactions         UserInteraction[]
  viewHistory          ViewHistory[]
  resourceEdits        ResourceEdit[]
  journeyProgress      UserJourneyProgress[]
  stepCompletions      StepCompletion[]
  apiKeys              ApiKey[]
  learningJourneys     LearningJourney[]   @relation("JourneyCreator")
}

model Session {
  id        String   @id @default(cuid())
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Account {
  id                    String    @id @default(cuid())
  accountId             String
  providerId            String
  userId                String
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Verification {
  id         String    @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime? @default(now())
  updatedAt  DateTime? @updatedAt
}

// ============================================================================
// Content Tables
// ============================================================================

model Resource {
  id               Int            @id @default(autoincrement())
  title            String
  url              String         @unique
  description      String
  categoryId       Int
  subcategoryId    Int?
  subSubcategoryId Int?
  status           ResourceStatus @default(pending)
  submittedById    String?
  approvedById     String?
  approvedAt       DateTime?
  ogImage          String?
  blurhash         String?
  githubSynced     Boolean        @default(false)
  lastSyncedAt     DateTime?
  metadata         Json           @default("{}")
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  category       Category          @relation(fields: [categoryId], references: [id])
  subcategory    Subcategory?      @relation(fields: [subcategoryId], references: [id])
  subSubcategory SubSubcategory?   @relation(fields: [subSubcategoryId], references: [id])
  submittedBy    User?             @relation("SubmittedResources", fields: [submittedById], references: [id])
  approvedBy     User?             @relation("ApprovedResources", fields: [approvedById], references: [id])
  tags           ResourceTag[]
  favorites      UserFavorite[]
  bookmarks      UserBookmark[]
  interactions   UserInteraction[]
  viewHistory    ViewHistory[]
  edits          ResourceEdit[]
  auditLogs      ResourceAuditLog[]
  journeySteps   JourneyStep[]
  githubMappings GithubResourceMapping[]

  @@index([categoryId])
  @@index([status])
  @@index([createdAt])
}

model Category {
  id           Int    @id @default(autoincrement())
  name         String
  slug         String @unique
  description  String?
  icon         String?
  displayOrder Int    @default(0)

  resources     Resource[]
  subcategories Subcategory[]
}

model Subcategory {
  id           Int    @id @default(autoincrement())
  name         String
  slug         String
  description  String?
  displayOrder Int    @default(0)
  categoryId   Int

  category          Category          @relation(fields: [categoryId], references: [id])
  resources         Resource[]
  subSubcategories  SubSubcategory[]

  @@unique([categoryId, slug])
}

model SubSubcategory {
  id            Int    @id @default(autoincrement())
  name          String
  slug          String
  description   String?
  displayOrder  Int    @default(0)
  subcategoryId Int

  subcategory Subcategory @relation(fields: [subcategoryId], references: [id])
  resources   Resource[]

  @@unique([subcategoryId, slug])
}

model Tag {
  id          Int     @id @default(autoincrement())
  name        String
  slug        String  @unique
  description String?

  resources ResourceTag[]
}

model ResourceTag {
  id         Int @id @default(autoincrement())
  resourceId Int
  tagId      Int

  resource Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)
  tag      Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([resourceId, tagId])
}

// ============================================================================
// User Interaction Tables
// ============================================================================

model UserFavorite {
  id         Int      @id @default(autoincrement())
  userId     String
  resourceId Int
  createdAt  DateTime @default(now())

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  resource Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  @@unique([userId, resourceId])
}

model UserBookmark {
  id         Int      @id @default(autoincrement())
  userId     String
  resourceId Int
  notes      String?
  createdAt  DateTime @default(now())

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  resource Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  @@unique([userId, resourceId])
}

model UserPreference {
  id                  Int      @id @default(autoincrement())
  userId              String   @unique
  skillLevel          String?
  preferredCategories Json     @default("[]")
  learningGoals       Json     @default("[]")
  timeCommitment      String?
  theme               String   @default("cyberpunk")
  viewMode            String   @default("grid")
  emailNotifications  Boolean  @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model UserInteraction {
  id         Int             @id @default(autoincrement())
  userId     String
  resourceId Int
  type       InteractionType
  metadata   Json            @default("{}")
  createdAt  DateTime        @default(now())

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  resource Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([resourceId])
}

model ViewHistory {
  id         Int      @id @default(autoincrement())
  userId     String
  resourceId Int
  viewedAt   DateTime @default(now())

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  resource Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([resourceId])
}

// ============================================================================
// Edit Tables
// ============================================================================

model ResourceEdit {
  id              Int        @id @default(autoincrement())
  resourceId      Int
  submittedById   String
  status          EditStatus @default(pending)
  editType        EditType
  justification   String
  proposedChanges Json
  aiAnalysis      Json?
  reviewedById    String?
  reviewedAt      DateTime?
  reviewFeedback  String?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  resource    Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)
  submittedBy User     @relation(fields: [submittedById], references: [id])
}

model ResourceAuditLog {
  id            Int      @id @default(autoincrement())
  resourceId    Int
  action        String
  performedById String
  previousState Json?
  newState      Json?
  createdAt     DateTime @default(now())

  resource Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)
}

// ============================================================================
// Journey Tables
// ============================================================================

model LearningJourney {
  id                Int               @id @default(autoincrement())
  title             String
  description       String
  difficulty        JourneyDifficulty @default(beginner)
  estimatedDuration String?
  category          String
  status            JourneyStatus     @default(draft)
  featured          Boolean           @default(false)
  createdById       String
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  createdBy   User                  @relation("JourneyCreator", fields: [createdById], references: [id])
  steps       JourneyStep[]
  enrollments UserJourneyProgress[]
}

model JourneyStep {
  id          Int    @id @default(autoincrement())
  journeyId   Int
  resourceId  Int?
  title       String
  description String?
  stepOrder   Int
  isOptional  Boolean @default(false)

  journey     LearningJourney  @relation(fields: [journeyId], references: [id], onDelete: Cascade)
  resource    Resource?        @relation(fields: [resourceId], references: [id])
  completions StepCompletion[]
}

model UserJourneyProgress {
  id          Int       @id @default(autoincrement())
  userId      String
  journeyId   Int
  startedAt   DateTime  @default(now())
  completedAt DateTime?
  updatedAt   DateTime  @updatedAt

  user    User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  journey LearningJourney @relation(fields: [journeyId], references: [id], onDelete: Cascade)

  @@unique([userId, journeyId])
}

model StepCompletion {
  id        Int      @id @default(autoincrement())
  userId    String
  stepId    Int
  rating    Int?
  timeSpent Int?
  notes     String?
  createdAt DateTime @default(now())

  user User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  step JourneyStep @relation(fields: [stepId], references: [id], onDelete: Cascade)

  @@unique([userId, stepId])
}

// ============================================================================
// AI Tables
// ============================================================================

model EnrichmentJob {
  id            Int                   @id @default(autoincrement())
  status        EnrichmentJobStatus   @default(pending)
  filter        String                @default("unenriched")
  totalItems    Int                   @default(0)
  processedItems Int                  @default(0)
  failedItems   Int                   @default(0)
  skippedItems  Int                   @default(0)
  startedAt     DateTime?
  completedAt   DateTime?
  errorLog      Json                  @default("[]")
  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt

  queueItems EnrichmentQueueItem[]
}

model EnrichmentQueueItem {
  id         Int                 @id @default(autoincrement())
  jobId      Int
  resourceId Int
  status     EnrichmentJobStatus @default(pending)
  retryCount Int                 @default(0)
  error      String?
  result     Json?
  createdAt  DateTime            @default(now())
  updatedAt  DateTime            @updatedAt

  job EnrichmentJob @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([jobId])
  @@index([status])
}

model AiResponseCache {
  id          Int      @id @default(autoincrement())
  contentHash String   @unique
  prompt      String
  response    Json
  model       String
  tokensUsed  Int      @default(0)
  hitCount    Int      @default(0)
  createdAt   DateTime @default(now())
  expiresAt   DateTime?
}

model AiUsageDaily {
  id          Int      @id @default(autoincrement())
  date        DateTime @db.Date
  model       String
  requestCount Int     @default(0)
  totalTokens Int      @default(0)
  estimatedCostUsd Float @default(0)
  createdAt   DateTime @default(now())

  @@unique([date, model])
}

// ============================================================================
// Research Tables
// ============================================================================

model ResearchJob {
  id          Int             @id @default(autoincrement())
  type        ResearchJobType
  status      EnrichmentJobStatus @default(pending)
  config      Json            @default("{}")
  report      Json?
  startedAt   DateTime?
  completedAt DateTime?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  findings ResearchFinding[]
}

model ResearchFinding {
  id          Int      @id @default(autoincrement())
  jobId       Int
  type        String
  title       String
  description String
  confidence  Float    @default(0)
  data        Json     @default("{}")
  applied     Boolean  @default(false)
  dismissed   Boolean  @default(false)
  createdAt   DateTime @default(now())

  job ResearchJob @relation(fields: [jobId], references: [id], onDelete: Cascade)
}

// ============================================================================
// GitHub Tables
// ============================================================================

model AwesomeList {
  id          Int      @id @default(autoincrement())
  name        String
  repoOwner   String
  repoName    String
  branch      String   @default("main")
  filePath    String   @default("README.md")
  lastSyncAt  DateTime?
  syncEnabled Boolean  @default(false)
  config      Json     @default("{}")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  syncHistory GithubSyncHistory[]
  syncQueue   GithubSyncQueue[]

  @@unique([repoOwner, repoName])
}

model GithubSyncQueue {
  id          Int              @id @default(autoincrement())
  listId      Int
  action      GithubSyncAction
  status      EnrichmentJobStatus @default(pending)
  payload     Json             @default("{}")
  error       String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  list AwesomeList @relation(fields: [listId], references: [id], onDelete: Cascade)

  @@index([status])
}

model GithubSyncHistory {
  id          Int      @id @default(autoincrement())
  listId      Int
  action      String
  status      String
  itemsAdded  Int      @default(0)
  itemsUpdated Int     @default(0)
  itemsSkipped Int     @default(0)
  conflicts   Int      @default(0)
  errorLog    Json     @default("[]")
  snapshot    Json?
  createdAt   DateTime @default(now())

  list AwesomeList @relation(fields: [listId], references: [id], onDelete: Cascade)
}

model GithubResourceMapping {
  id          Int      @id @default(autoincrement())
  resourceId  Int
  listId      Int
  lineNumber  Int?
  sectionPath String?
  lastSyncAt  DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  resource Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  @@unique([resourceId, listId])
}

// ============================================================================
// API Tables
// ============================================================================

model ApiKey {
  id         String    @id @default(cuid())
  userId     String
  keyHash    String    @unique
  keyPrefix  String
  name       String
  tier       ApiKeyTier @default(free)
  scopes     String[]  @default([])
  lastUsedAt DateTime?
  expiresAt  DateTime?
  revokedAt  DateTime?
  createdAt  DateTime  @default(now())

  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  rateLimit ApiRateLimit?
  usageLogs ApiUsageLog[]
}

model ApiRateLimit {
  id          Int      @id @default(autoincrement())
  apiKeyId    String   @unique
  windowStart DateTime @default(now())
  requestCount Int     @default(0)
  updatedAt   DateTime @updatedAt

  apiKey ApiKey @relation(fields: [apiKeyId], references: [id], onDelete: Cascade)
}

model ApiUsageLog {
  id        Int      @id @default(autoincrement())
  apiKeyId  String
  endpoint  String
  method    String
  statusCode Int
  responseTime Int
  createdAt DateTime @default(now())

  apiKey ApiKey @relation(fields: [apiKeyId], references: [id], onDelete: Cascade)

  @@index([apiKeyId])
  @@index([createdAt])
}

// ============================================================================
// Config Table
// ============================================================================

model SiteSetting {
  id          Int      @id @default(autoincrement())
  key         String   @unique
  value       Json
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
